{"name":"Smartos-notes","tagline":"because smartOS is smarter than me...","body":"<br>\r\n![OSLOGO](https://wiki.smartos.org/download/attachments/753666/DOC?version=1&modificationDate=1333386297000)\r\n<br>\r\n\r\n#SmartOS, from scratch\r\n\r\n##Base OS\r\n\r\n### Download\r\n\r\nIf you have downloaded as used the CoaL and/or USB packages, new builds are available here:\r\n\r\n#### Cloud On A Laptop (VMware):\r\n```\r\ncurl -C - -O https://us-east.manta.joyent.com/Joyent_Dev/public/SmartDataCenter/coal-latest.tgz\r\n```        \r\n#### USB key image:\r\n```\r\ncurl -C - -O https://us-east.manta.joyent.com/Joyent_Dev/public/SmartDataCenter/usb-latest.tgz\r\n```\r\n\r\n#### Make USB key\r\n\r\nhttps://docs.joyent.com/private-cloud/install/usb-key/mac-osx\r\n\r\n### Install\r\n\r\nhttps://docs.joyent.com/private-cloud/install\r\n\r\nor\r\n\r\nhttps://wiki.smartos.org/display/DOC/SmartOS+Clean+Re-install\r\n\r\n#### boot console change required?\r\n\r\n```\r\nvariable os_console vga\r\n```\r\nNote: If the system sits a flashing cursor or does not show any activity for an extended period of time (greater than 20 minutes) you may need to change the Console. Please see Changing the boot-time console for details.\r\n\r\nhttps://docs.joyent.com/private-cloud/install#bootconsole\r\n\r\nChanging the boot-time console\r\nTo change to a different console device, prior to booting the Live 64 Bit menu item, you will need to:\r\n\r\n* Scroll down to the Live 64 Bit menu option.\r\n* Press the c key to open a command window.\r\n* Enter one of the following:\r\n\r\n\r\n\r\n### Post Install\r\n\r\nhttps://docs.joyent.com/private-cloud/install/post-installation#AddingExternalNICstoHeadNodeVMs\r\n\r\n#### SSH Keys\r\n\r\nhttps://docs.joyent.com/private-cloud/install#sshkeys\r\n\r\nPopulating root's authorized_keys file on boot\r\nIt is possible to have Triton Elastic Container Infrastructure automatically add SSH keys to the ~root/.ssh/authorized_keys file on boot. To do this, you need to add a file called root.authorized_keys to the /mnt/usbkey/config.inc directory on the USB key.\r\n\r\nNote: The directory path given assumes you are mounting under /mnt/usbkey. You will need to adjust this as appropriate. For example, under /Volumes/HEADNODE if you are mounting it under OS X.\r\n\r\n#### If just a headnode, no cluster then need to allow headnode provioning\r\n\r\n```\r\nsdcadm post-setup dev-headnode-prov\r\n```\r\n\r\n#### In order to downlaod images via SDC, the SDC zone needs an external link\r\n\r\n```\r\nsdcadm post-setup common-external-nics\r\n```\r\n\r\n##### Possible error if via SSH\r\n```\r\nsdcadm post-setup: error: requests must originate from CNAPI address\r\n```\r\n\r\n#### Patch your \"s\"\r\n\r\n```\r\nsdcadm self-update --latest\r\n\r\nOUTPUT\r\n\r\nUpdate to sdcadm 1.9.0 (master-20151221T171321Z-gabeeae7)\r\nDownload update from https://updates.joyent.com\r\nRun sdcadm installer (log at /var/sdcadm/self-updates/20151222T062616Z/install.log)\r\nUpdated to sdcadm 1.9.0 (master-20151221T171321Z-gabeeae7, elapsed 24s)\r\n\r\n```\r\n\r\n#### Find your Admin UI ip address\r\n\r\nTo connect to the admin UI you need its IP.... find it with this command\r\n\r\n\r\n```\r\nvmadm list -o uuid,type,ram,nics.0.ip,quota,alias | grep -v KVM\r\n\r\n```\r\nand look for\r\n\r\n```\r\n........ 192.168.3.74          25     adminui0\r\n```\r\nso in this case we need to hit\r\n\r\nhttps://192.168.3.74/\r\n\r\n```\r\nOUTPUT\r\n\r\nUUID                                  TYPE  RAM      NICS.0.IP             QUOTA  ALIAS\r\n74f4581d-eae8-4b7b-adce-262490086b11  OS    128      192.168.3.52          25     dhcpd0\r\n80df3d39-9f7a-4f1c-8211-69e1599f0439  OS    128      192.168.3.51          25     assets0\r\nf26024ab-4885-4704-912b-6e0141963d38  OS    256      192.168.3.53          25     napi0\r\n06936339-9b04-4198-bfe9-5552d1010568  OS    512      192.168.3.75          25     sapi0\r\n01c700a6-fc5a-4f20-9de5-75bd6fc8f061  OS    768      192.168.3.64          500    imgapi0\r\n0cca8147-d54b-46c8-a799-f2d3450e2ce0  OS    1024     192.168.3.81          25     cloudapi0\r\n2d8a57c8-0ec6-45e6-a72e-8b6d514c7f89  OS    1024     192.168.3.68          25     amon0\r\n898dc86a-911a-4807-88c7-b3a9f68cba9f  OS    1024     192.168.3.76          25     mahi0\r\n9d37a5ec-8d36-4610-9d00-5759183bd227  OS    1024     192.168.3.66          25     amonredis0\r\n9ec8da42-c542-453d-aec2-17ba84d033a1  OS    1024     192.168.3.67          25     redis0\r\na3101294-ae7e-459e-8373-6ef8a78561df  OS    1024     192.168.3.69          25     fwapi0\r\naf1337b0-bdb1-4875-a7ac-2e11f1fbc0b3  OS    1024     192.168.3.70          25     vmapi0\r\ncbc626d5-7067-4529-b0b3-7fccc717ef87  OS    1024     192.168.3.65          25     cnapi0\r\ne2153c53-7003-4551-ad66-055b8409872c  OS    1024     192.168.3.71          25     sdc0\r\nea94c792-be2a-4604-bed4-7fbf4407bd1c  OS    1024     192.168.3.54          25     binder0\r\neb4f5b6a-ee95-4283-9b0a-b981dbb00231  OS    1024     192.168.3.72          25     papi0\r\n0b149fbf-278b-46cc-9a92-1bd8faf0c4b2  OS    2048     192.168.3.59          50     manatee0\r\n18965243-0410-4b84-a317-e38c87fef581  OS    2048     192.168.3.63          25     rabbitmq0\r\n7ffc990d-4082-4525-88fd-cee0acef40f9  OS    2048     192.168.3.74          25     adminui0\r\n5d9aaf63-0105-44b7-87e2-d70f376ec2b5  OS    4096     192.168.3.73          25     ca0\r\n18e26bcc-a062-4a86-a9ff-341075a94f80  OS    8192     192.168.3.60          25     moray0\r\n474d8049-0884-495f-890f-dd7a51ab72ce  OS    8192     192.168.3.62          25     workflow0\r\nfe6b8008-fdcc-44ea-859f-87589a93e25d  OS    8192     192.168.3.61          25     ufds0\r\n```\r\n\r\n### Create VMs\r\n\r\n#### How to create a Virtual Machine in SmartOS\r\n\r\nhttps://wiki.smartos.org/display/DOC/How+to+create+a+Virtual+Machine+in+SmartOS\r\n\r\n#### KVMs (General)\r\nhttps://wiki.smartos.org/display/DOC/How+to+create+a+KVM+VM+(+Hypervisor+virtualized+machine+)+in+SmartOS\r\n\r\n#### Docker\r\n\r\nhttps://docs.joyent.com/private-cloud/install/post-installation#setting-up-docker\r\n\r\n#### Plex\r\nhttp://lightsandshapes.com/plex-on-smartos.html\r\n\r\n#### Pfsense\r\n\r\nhttps://forum.pfsense.org/index.php?topic=69820.0\r\n\r\n#### SmartOS VM Migration using DD & Netcat\r\n\r\nhttps://www.youtube.com/watch?v=7xrb_WZZ-Cs\r\n\r\n### Delete / manage existing VMs\r\n\r\nhttps://wiki.smartos.org/display/DOC/Using+vmadm+to+manage+virtual+machines#Usingvmadmtomanagevirtualmachines-DeletingaVM\r\n\r\n\r\n\r\n### VNC notes\r\n\r\nhttps://github.com/TigerVNC/tigervnc/releases\r\n\r\nconnect to **admin IP** and zone port (not zone IP)\r\n\r\n### Tools\r\n\r\nhttp://timboudreau.com/blog/smartos/read\r\n\r\n#### GB / MB Rounding\r\n\r\nIn oder to create a machine via SDC you need the **exact** size (e.g. 40000 mb is not accurate enough) so 40Gb is actually 40960 MB so you need to 40960, no less, no more.... (note google is not strict enough)\r\n\r\nuse this converter to help\r\n\r\nhttp://www.convertunits.com/from/GB/to/MB\r\n\r\n#### AWESOME TIPS\r\n\r\nhttps://wiki.smartos.org/display/DOC/SmartOS+Command+Line+Tips\r\n\r\n\r\n\r\n---------------------------\r\n\r\n# PFsense Specific (in progress - don't follow!)\r\n\r\nhttps://wiki.smartos.org/display/DOC/Managing+NICs\r\n\r\n```\r\ndladm create-vnic -l e1000g1 pfsenseguest0\r\ndladm create-vnic -l e1000g0 pfsenselan0\r\n\r\nifconfig pfsenseguest0 plumb\r\nifconfig pfsenselan0 plumb\r\nifconfig pfsenseguest0 dhcp\r\nifconfig pfsenselan0 dhcp\r\n```\r\n\r\n### I generally create a permanent home for ISO images and JSON files:\r\n\r\n```\r\nzfs create zones/images\r\n```\r\n* Place the pfSense ISO there\r\n\r\n## identify the MAC addresses of the Ethernet interfaces\r\n```\r\ndladm show-phys -m\r\n\r\n[root@smartoshost ~]# dladm show-phys -m\r\nLINK         SLOT     ADDRESS            INUSE CLIENT\r\nbnx0         primary  a4:ba:db:3e:ad:a1  yes  bnx0\r\ne1000g0      primary  0:15:17:ec:1:d3    yes  e1000g0\r\nbnx1         primary  a4:ba:db:3e:ad:a3  yes  bnx1\r\ne1000g2      primary  0:15:17:ec:1:cd    yes  e1000g2\r\ne1000g1      primary  0:1b:21:57:c:85    yes  e1000g1\r\n```\r\n**e1000g0 is probably the 'admin' interface, verify this by viewing /usbkey/config.**\r\n\r\n* Then edit /usbkey/config and add a line for the 2nd MAC address as follows:\r\n\r\n```\r\nexternal_nic=xx:xx:xx:xx:xx:xx (substitute the 2nd MAX address)\r\n```\r\n\r\n* re-boot SmartOS\r\n* Create the pfsense.json file (below) in zones/images\r\n* Modify the IP information as appropriate\r\n* The admin NIC is shared with SmartOS so it should be on the INSIDE (LAN) subnet,\r\n* the external NIC is the INTERNET/PUBLIC/WAN side\r\n**Note the vnc port number is specified - this must be unique.**\r\n**The VM is set to not autoboot - change this later using**\r\n```\r\nvmadm update $UUID autoboot=true\r\n```\r\n\r\n\r\n```\r\nzfs create zones/images\r\n```\r\n\r\n\r\n\r\n```json\r\n{\r\n  \"brand\": \"kvm\",\r\n  \"vcpus\": 1,\r\n  \"ram\": 1024,\r\n  \"hostname\": \"pfsense\",\r\n  \"alias\": \"pfsense\",\r\n  \"resolvers\": [\"192.168.2.1\", \"8.8.8.8\"],\r\n  \"vnc_port\": \"40000\",\r\n  \"autoboot\": \"false\",\r\n  \"disks\": [\r\n    {\r\n      \"boot\": true,\r\n      \"model\": \"ide\",\r\n      \"size\": 4096\r\n    }\r\n  ],\r\n  \"nics\": [\r\n    {\r\n      \"nic_tag\": \"admin\",\r\n      \"model\": \"e1000\",\r\n      \"ip\": \"192.168.3.1\",\r\n      \"netmask\": \"255.255.0.0\",\r\n      \"gateway\": \"192.168.2.1\",\r\n      \"allow_dhcp_spoofing\": true,\r\n      \"allow_ip_spoofing\": true,\r\n      \"allow_mac_spoofing\": true,\r\n      \"allow_restricted_traffic\": true,\r\n      \"primary\":\"1\"\r\n    },\r\n    {\r\n      \"nic_tag\": \"external\",\r\n      \"model\": \"e1000\",\r\n      \"ip\": \"192.168.2.30\",\r\n      \"netmask\": \"255.255.0.0\",\r\n      \"gateway\": \"192.168.2.1\",\r\n      \"allow_dhcp_spoofing\": true,\r\n      \"allow_ip_spoofing\": true,\r\n      \"allow_mac_spoofing\": true,\r\n      \"allow_restricted_traffic\": true\r\n    },\r\n    {\r\n      \"nic_tag\": \"GuestLAN\",\r\n      \"model\": \"e1000\",\r\n      \"ip\": \"192.168.4.2\",\r\n      \"netmask\": \"255.255.0.0\",\r\n      \"gateway\": \"192.168.2.1\",\r\n      \"allow_dhcp_spoofing\": true,\r\n      \"allow_ip_spoofing\": true,\r\n      \"allow_mac_spoofing\": true,\r\n      \"allow_restricted_traffic\": true\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n\r\n```\r\nvmadm create -f pfsense.json\r\n```\r\nsubstitute the created VM's UUID for $UUID in the following commands, or\r\n```\r\nexport UUID=zoneuuid\r\n```\r\n```\r\ncp /zones/images/pfSense-LiveCD-2.0.3-RELEASE-amd64.iso  /zones/$UUID/root/\r\nvmadm boot $UUID order=cd,once=d cdrom=/pfSense-LiveCD-2.0.3-RELEASE-amd64.iso,ide\r\n```\r\n\r\n## This step can probably be done before booting the VM -- and should be, if possible\r\n\r\n### examine the active JSON using:\r\n\r\n```\r\nvmadm get $UUID | less\r\n```\r\n\r\nand write down the last 4 digits of the MAC addresses for the admin and external nics, eg:\r\n\r\n```\r\nadmin=a9:af\r\nexternal=aa:ab\r\n\r\n```\r\n\r\n```json\r\n[root@smartoshost /opt]# vmadm get $UUID\r\n{\r\n  \"zonename\": \"6362bbce-ff4b-6db3-cdd3-bf6e508242dc\",\r\n  \"autoboot\": true,\r\n  \"brand\": \"kvm\",\r\n  \"limit_priv\": \"default,-file_link_any,-net_access,-proc_fork,-proc_info,-proc_session\",\r\n  \"v\": 1,\r\n  \"create_timestamp\": \"2015-12-17T01:07:15.174Z\",\r\n  \"cpu_shares\": 100,\r\n  \"max_lwps\": 2000,\r\n  \"max_msg_ids\": 4096,\r\n  \"max_sem_ids\": 4096,\r\n  \"max_shm_ids\": 4096,\r\n  \"max_shm_memory\": 2048,\r\n  \"zfs_io_priority\": 100,\r\n  \"max_physical_memory\": 2048,\r\n  \"max_locked_memory\": 2048,\r\n  \"max_swap\": 2048,\r\n  \"billing_id\": \"00000000-0000-0000-0000-000000000000\",\r\n  \"owner_uuid\": \"00000000-0000-0000-0000-000000000000\",\r\n  \"hostname\": \"pfsense\",\r\n  \"resolvers\": [\r\n    \"192.168.2.1\",\r\n    \"8.8.8.8\"\r\n  ],\r\n  \"alias\": \"pfsense\",\r\n  \"ram\": 1024,\r\n  \"vcpus\": 1,\r\n  \"vnc_port\": 40000,\r\n  \"disks\": [\r\n    {\r\n      \"path\": \"/dev/zvol/rdsk/zones/6362bbce-ff4b-6db3-cdd3-bf6e508242dc-disk0\",\r\n      \"boot\": true,\r\n      \"model\": \"ide\",\r\n      \"media\": \"disk\",\r\n      \"zfs_filesystem\": \"zones/6362bbce-ff4b-6db3-cdd3-bf6e508242dc-disk0\",\r\n      \"zpool\": \"zones\",\r\n      \"size\": 4096,\r\n      \"compression\": \"off\",\r\n      \"refreservation\": 4096,\r\n      \"block_size\": 8192\r\n    }\r\n  ],\r\n  \"nics\": [\r\n    {\r\n      \"interface\": \"net0\",\r\n      \"mac\": \"b2:64:a0:b2:43:c9\",\r\n      \"nic_tag\": \"admin\",\r\n      \"gateway\": \"192.168.2.1\",\r\n      \"gateways\": [\r\n        \"192.168.2.1\"\r\n      ],\r\n      \"netmask\": \"255.255.0.0\",\r\n      \"ip\": \"192.168.2.1\",\r\n      \"ips\": [\r\n        \"192.168.2.1/16\"\r\n      ],\r\n      \"model\": \"e1000\",\r\n      \"allow_dhcp_spoofing\": true,\r\n      \"allow_ip_spoofing\": true,\r\n      \"allow_mac_spoofing\": true,\r\n      \"allow_restricted_traffic\": true,\r\n      \"primary\": true\r\n    },\r\n    {\r\n      \"interface\": \"net1\",\r\n      \"mac\": \"e2:26:d1:5e:10:98\",\r\n      \"nic_tag\": \"external\",\r\n      \"gateway\": \"192.168.3.1\",\r\n      \"gateways\": [\r\n        \"192.168.3.1\"\r\n      ],\r\n      \"netmask\": \"255.255.0.0\",\r\n      \"ip\": \"192.168.3.2\",\r\n      \"ips\": [\r\n        \"192.168.3.2/16\"\r\n      ],\r\n      \"model\": \"e1000\",\r\n      \"allow_dhcp_spoofing\": true,\r\n      \"allow_ip_spoofing\": true,\r\n      \"allow_mac_spoofing\": true,\r\n      \"allow_restricted_traffic\": true\r\n    },\r\n    {\r\n      \"interface\": \"net2\",\r\n      \"mac\": \"a2:66:b8:9a:ef:70\",\r\n      \"nic_tag\": \"GuestLAN\",\r\n      \"gateway\": \"192.168.2.1\",\r\n      \"gateways\": [\r\n        \"192.168.2.1\"\r\n      ],\r\n      \"netmask\": \"255.255.0.0\",\r\n      \"ip\": \"192.168.4.2\",\r\n      \"ips\": [\r\n        \"192.168.4.2/16\"\r\n      ],\r\n      \"model\": \"e1000\",\r\n      \"allow_dhcp_spoofing\": true,\r\n      \"allow_ip_spoofing\": true,\r\n      \"allow_mac_spoofing\": true,\r\n      \"allow_restricted_traffic\": true\r\n    }\r\n  ],\r\n  \"uuid\": \"6362bbce-ff4b-6db3-cdd3-bf6e508242dc\",\r\n  \"zone_state\": \"running\",\r\n  \"zonepath\": \"/zones/6362bbce-ff4b-6db3-cdd3-bf6e508242dc\",\r\n  \"zoneid\": 4,\r\n  \"last_modified\": \"2015-12-17T01:09:14.000Z\",\r\n  \"firewall_enabled\": false,\r\n  \"server_uuid\": \"44454c4c-4400-1059-804a-c6c04f353253\",\r\n  \"platform_buildstamp\": \"20151210T194528Z\",\r\n  \"state\": \"running\",\r\n  \"boot_timestamp\": \"2015-12-17T01:09:13.000Z\",\r\n  \"pid\": 7287,\r\n  \"customer_metadata\": {},\r\n  \"internal_metadata\": {},\r\n  \"routes\": {},\r\n  \"tags\": {},\r\n  \"quota\": 10,\r\n  \"zfs_root_recsize\": 131072,\r\n  \"zfs_filesystem\": \"zones/6362bbce-ff4b-6db3-cdd3-bf6e508242dc\",\r\n  \"zpool\": \"zones\",\r\n  \"snapshots\": []\r\n}\r\n```\r\n\r\n##vnc to the IP address and port 40000\r\n**if you reach the session before the boot timeout occurs, take option \"i\" to install**\r\n\r\n## Respond to prompts as follows:\r\n\r\nAccept these options\r\n\r\n* Quick/Easy install\r\n* Standard Kernel\r\n\r\n### After the reboot look for some lines that say:\r\n\r\n```\r\nValid interfaces are:\r\n# em0   xx:xx:xx:xx:xx:xx\r\n# em1   xx:xx:xx:xx:xx:xx\r\n```\r\n\r\nDetermine which of these matches the \"admin\" MAC address you noted earlier -- that is your LAN interface!\r\n\r\nThe other MAC address should match the \"external\" MAC address you noted - that is your WAN interface!\r\n\r\n```\r\nDo you want to setup VLANs now? N\r\nEnter the WAN interface name...: em?   (select the interface with a MAC address matching your external_nic)\r\nEnter the LAN interface name...: em?   (select the interface with a MAC address matching your admin_nic)\r\nEnter the optional 1 interface name...: (enter)\r\n```\r\n```\r\nFrom the menu:\r\n2: Set interface(s) IP address\r\nremember WAN = external_nic\r\nenter IP, netmask as prompted\r\nDo you want to revert to HTTP as the webConfigurator protocol? Y\r\n```\r\n\r\nRepeat menu option #2 for WAN, LAN\r\n\r\n* Restart webConfigurator\r\n* Enable Secure Shell (sshd)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}