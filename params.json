{"name":"SmartOS - SmartDataCenter notes","tagline":"because SmartOS is smarter than me...","body":"<br>\r\n![OSLOGO](https://wiki.smartos.org/download/attachments/753666/DOC?version=1&modificationDate=1333386297000)\r\n<br>\r\n\r\n#SmartOS - SmartDataCenter, from scratch, at home, with minimal gear..\r\n\r\n## My Setup\r\n\r\n* Dell T601\r\n* 6i raid card\r\n* 2 x 300gb drives\r\n* 2 x 2 tb drives\r\n* 16 GB ECC ram\r\n* \"Dumb\" GB switch (so no vlans for me :( next time...)\r\n* Old tplink wifi switch (for admin network)\r\n\r\n## Before you begin, nuggets of wisdom...\r\n\r\n* The **ADMIN** and **External** networks MUST be separate subnets\r\n\t* I used an old wifi router for **admin** on 192.168.10.1, you then need to give your laptop a static IP in that range to connect\r\n\t* The **external** went to my LAN on 192.168.2.x\r\n\t* later when provisioning a machine - ensure they are connected to the **external** network so they show up on your LAN\r\n\t* VNC is bound to the **ADMIN** network so need to connect to that to use it (I'm looking how to move it to the LAN side... but if thats your internet watch for security issues)\r\n* SDC installer does what it will with your disks, no options during install\r\n\t* So i used 1 x 300gb for the initial install\r\n\t* then before you add any zones follow the \"zpool expand\" section below (adapt to match your config)\r\n\r\n## Base OS\r\n\r\n### Download\r\n\r\nhttps://github.com/joyent/sdc\r\n\r\n#### Cloud On A Laptop (VMware):\r\n```\r\ncurl -C - -O https://us-east.manta.joyent.com/Joyent_Dev/public/SmartDataCenter/coal-latest.tgz\r\n```        \r\n#### USB key image:\r\n```\r\ncurl -C - -O https://us-east.manta.joyent.com/Joyent_Dev/public/SmartDataCenter/usb-latest.tgz\r\n```\r\n\r\n#### Make USB key\r\n\r\nhttps://docs.joyent.com/private-cloud/install/usb-key/mac-osx\r\n\r\n### Install\r\n\r\nhttps://docs.joyent.com/private-cloud/install\r\n\r\nor\r\n\r\nhttps://wiki.smartos.org/display/DOC/SmartOS+Clean+Re-install\r\n\r\nor\r\n\r\nhttps://wiki.smartos.org/display/DOC/Install+SDC+on+SmartOS\r\n\r\n#### boot console change required?... mine did\r\n\r\n```\r\nvariable os_console vga\r\n```\r\nNote: If the system sits a flashing cursor or does not show any activity for an extended period of time (greater than 20 minutes) you may need to change the Console. Please see Changing the boot-time console for details.\r\n\r\nhttps://docs.joyent.com/private-cloud/install#bootconsole\r\n\r\nChanging the boot-time console\r\nTo change to a different console device, prior to booting the Live 64 Bit menu item, you will need to:\r\n\r\n* Scroll down to the Live 64 Bit menu option.\r\n* Press the c key to open a command window.\r\n* Enter one of the following:\r\n\r\n\r\n\r\n### Post Install\r\n\r\n#### SSH Keys\r\n\r\nhttps://docs.joyent.com/private-cloud/install#sshkeys\r\n\r\nPopulating root's authorized_keys file on boot\r\nIt is possible to have Triton Elastic Container Infrastructure automatically add SSH keys to the ~root/.ssh/authorized_keys file on boot. To do this, you need to add a file called root.authorized_keys to the /mnt/usbkey/config.inc directory on the USB key.\r\n\r\nNote: The directory path given assumes you are mounting under /mnt/usbkey. You will need to adjust this as appropriate. For example, under /Volumes/HEADNODE if you are mounting it under OS X.\r\n\r\n#### If just a headnode (no cluster/ other compute nodes) then need to allow headnode provisioning\r\n\r\n```\r\nsdcadm post-setup dev-headnode-prov\r\n```\r\n\r\n#### In order to download images via SDC, the SDC adminui zone needs an external link\r\n\r\n```\r\nsdcadm post-setup common-external-nics\r\n```\r\n#### Save disk space with compression\r\n```\r\nzfs set compression=on zones && zfs get compression zones\r\n```\r\n\r\n```\r\nzfs get compressratio zones\r\n```\r\n\r\n##### Error I got after wiping the zpool and then not fresh installing SDC on USB\r\n\r\nI found no way out of this except to go back to make a new SDC image... and start from scratch\r\n\r\n```\r\nsdcadm post-setup: error: requests must originate from CNAPI address\r\n```\r\n\r\n#### Patch your \"s\"\r\n\r\nUpdate!\r\n\r\n##### Zones\r\n\r\n```\r\nsdcadm self-update --latest\r\n```\r\n\r\nOutput\r\n\r\n```\r\nUpdate to sdcadm 1.9.0 (master-20151221T171321Z-gabeeae7)\r\nDownload update from https://updates.joyent.com\r\nRun sdcadm installer (log at /var/sdcadm/self-updates/20151222T062616Z/install.log)\r\nUpdated to sdcadm 1.9.0 (master-20151221T171321Z-gabeeae7, elapsed 24s)\r\n\r\n```\r\n\r\nhttps://github.com/joyent/sdcadm/blob/master/docs/update.md\r\n\r\n##### USB / Platform\r\n\r\nThis is to get the latest release of SmartOS: \r\n\r\n```\r\nsdcadm platform install --latest\r\n```\r\n\r\nThen you need to assign it with example: \r\n\r\n```\r\nsdcadm platform assign 20160121T174713Z --all\r\n```\r\n\r\nThen reboot the compute/headnode and verify what the platform is: \r\n\r\n```\r\nuname -v\r\n```\r\n\r\nTypical output\r\n\r\n```\r\n[root@headnode (hat) ~]# sdcadm platform install --latest\r\nUsing channel release\r\nChecking latest Platform Image is already installed\r\nDownloading platform 20160121T174713Z\r\n    image 14008049-711d-4417-b2bd-0c91d6e32bd0\r\n    to /var/tmp/platform-release-20160121-20160121T174713Z.tgz\r\nInstalling Platform Image onto USB key\r\n==> Mounting USB key\r\n==> Staging 20160121T174713Z\r\n######################################################################## 100.0%\r\n==> Unpacking 20160121T174713Z to /mnt/usbkey/os\r\n==> This may take a while...\r\n==> Copying 20160121T174713Z to /usbkey/os\r\n==> Unmounting USB Key\r\n==> Adding to list of available platforms\r\n==> Done!\r\nPlatform installer finished successfully\r\nProceeding to complete the update\r\nInstallation complete\r\nYou have new mail in /var/mail/root\r\n[root@headnode (hat) ~]# uname -v\r\njoyent_20151210T064915Z\r\nYou have new mail in /var/mail/root\r\n[root@headnode (hat) ~]# sdcadm platform assign 20160121T174713Z --all\r\nupdating headnode 002590d5-384a-0607-0025-90d5384a0e0f to 20160121T174713Z\r\nSetting boot params for 002590d5-384a-0607-0025-90d5384a0e0f\r\nUpdating booter cache for servers\r\nDone updating booter caches\r\nVerifying boot_platform updates\r\nCleaned up deprecated 'latest' symlink\r\nUpdating default boot platform to '20160121T174713Z'\r\n[root@headnode (hat) ~]# uname -v\r\njoyent_20151210T064915Z\r\n[root@headnode (hat) ~]#\r\n\r\n```\r\n\r\n#### Find your Admin UI ip address\r\n\r\nTo connect to the admin UI you need its IP.... find it with this command\r\n\r\n\r\n```\r\nvmadm list -o uuid,type,ram,nics.0.ip,quota,alias | grep -v KVM\r\n\r\n```\r\n\r\nOR to try your other nic (admin v's external for example)\r\n\r\n```\r\nvmadm list -o uuid,type,ram,nics.1.ip,quota,alias | grep -v KVM\r\n\r\n```\r\n\r\nand look for\r\n\r\n```\r\n........ 192.168.3.74          25     adminui0\r\n```\r\nso in this case we need to hit\r\n\r\nhttps://192.168.3.74/\r\n\r\n```\r\nOUTPUT\r\n\r\nUUID                                  TYPE  RAM      NICS.0.IP             QUOTA  ALIAS\r\n74f4581d-eae8-4b7b-adce-262490086b11  OS    128      192.168.3.52          25     dhcpd0\r\n80df3d39-9f7a-4f1c-8211-69e1599f0439  OS    128      192.168.3.51          25     assets0\r\nf26024ab-4885-4704-912b-6e0141963d38  OS    256      192.168.3.53          25     napi0\r\n06936339-9b04-4198-bfe9-5552d1010568  OS    512      192.168.3.75          25     sapi0\r\n01c700a6-fc5a-4f20-9de5-75bd6fc8f061  OS    768      192.168.3.64          500    imgapi0\r\n0cca8147-d54b-46c8-a799-f2d3450e2ce0  OS    1024     192.168.3.81          25     cloudapi0\r\n2d8a57c8-0ec6-45e6-a72e-8b6d514c7f89  OS    1024     192.168.3.68          25     amon0\r\n898dc86a-911a-4807-88c7-b3a9f68cba9f  OS    1024     192.168.3.76          25     mahi0\r\n9d37a5ec-8d36-4610-9d00-5759183bd227  OS    1024     192.168.3.66          25     amonredis0\r\n9ec8da42-c542-453d-aec2-17ba84d033a1  OS    1024     192.168.3.67          25     redis0\r\na3101294-ae7e-459e-8373-6ef8a78561df  OS    1024     192.168.3.69          25     fwapi0\r\naf1337b0-bdb1-4875-a7ac-2e11f1fbc0b3  OS    1024     192.168.3.70          25     vmapi0\r\ncbc626d5-7067-4529-b0b3-7fccc717ef87  OS    1024     192.168.3.65          25     cnapi0\r\ne2153c53-7003-4551-ad66-055b8409872c  OS    1024     192.168.3.71          25     sdc0\r\nea94c792-be2a-4604-bed4-7fbf4407bd1c  OS    1024     192.168.3.54          25     binder0\r\neb4f5b6a-ee95-4283-9b0a-b981dbb00231  OS    1024     192.168.3.72          25     papi0\r\n0b149fbf-278b-46cc-9a92-1bd8faf0c4b2  OS    2048     192.168.3.59          50     manatee0\r\n18965243-0410-4b84-a317-e38c87fef581  OS    2048     192.168.3.63          25     rabbitmq0\r\n7ffc990d-4082-4525-88fd-cee0acef40f9  OS    2048     192.168.3.74          25     adminui0\r\n5d9aaf63-0105-44b7-87e2-d70f376ec2b5  OS    4096     192.168.3.73          25     ca0\r\n18e26bcc-a062-4a86-a9ff-341075a94f80  OS    8192     192.168.3.60          25     moray0\r\n474d8049-0884-495f-890f-dd7a51ab72ce  OS    8192     192.168.3.62          25     workflow0\r\nfe6b8008-fdcc-44ea-859f-87589a93e25d  OS    8192     192.168.3.61          25     ufds0\r\n```\r\n\r\n#### Adding more NICs\r\n\r\nhttps://docs.joyent.com/private-cloud/install/post-installation#AddingExternalNICstoHeadNodeVMs\r\n\r\n### Create VMs\r\n\r\n#### How to create a Virtual Machine in SmartOS\r\n\r\nhttps://wiki.smartos.org/display/DOC/How+to+create+a+Virtual+Machine+in+SmartOS\r\n\r\n#### KVMs (General)\r\nhttps://wiki.smartos.org/display/DOC/How+to+create+a+KVM+VM+(+Hypervisor+virtualized+machine+)+in+SmartOS\r\n\r\n#### Docker\r\n\r\nhttps://docs.joyent.com/private-cloud/install/post-installation#setting-up-docker\r\n\r\n#### Plex\r\nhttp://lightsandshapes.com/plex-on-smartos.html\r\n\r\n#### Pfsense\r\n\r\nhttps://forum.pfsense.org/index.php?topic=69820.0\r\n\r\n#### SmartOS VM Migration using DD & Netcat\r\n\r\nhttps://www.youtube.com/watch?v=7xrb_WZZ-Cs\r\n\r\n### Delete / manage existing VMs\r\n\r\nhttps://wiki.smartos.org/display/DOC/Using+vmadm+to+manage+virtual+machines#Usingvmadmtomanagevirtualmachines-DeletingaVM\r\n\r\n### Disk full issue\r\n\r\nENOSPC, open '/zones...metadata.json'\r\nSmartOS.\r\n\r\nIssuing this command\r\n\r\nvmadm update f7c4fbb0-aa35-41d4-9d21-614caba785c7 max_physical_memory=2048\r\n\r\nI got an error like\r\n\r\nENOSPC, open '/zones/f7c4fbb0-aa35-41d4-9d21-614caba785c7/config/metadata.json'\r\n\r\n\r\nI try to enter in the zone\r\n\r\nzlogin f7c4fbb0-aa35-41d4-9d21-614caba785c7\r\n\r\nbut I got\r\n\r\n[Connected to zone 'f7c4fbb0-aa35-41d4-9d21-614caba785c7' pts/12]\r\nNo utmpx entry. You must exec \"login\" from the lowest level \"shell\".\r\n\r\n[Connection to zone 'f7c4fbb0-aa35-41d4-9d21-614caba785c7' pts/12 closed]\r\n\r\n\r\nWTF?\r\n\r\nThe zone reached the zfs disk quota. Disk full.\r\n\r\nBut also\r\nvmadm update f7c4fbb0-aa35-41d4-9d21-614caba785c7 quota=50\r\nreturns\r\nENOSPC, open '/zones/f7c4fbb0-aa35-41d4-9d21-614caba785c7/config/metadata.json'\r\n\r\n\r\nSo the solution is simple:\r\n\r\nzfs set quota=40G zones/f7c4fbb0-aa35-41d4-9d21-614caba785c7\r\n\r\nvmadm update f7c4fbb0-aa35-41d4-9d21-614caba785c7 max_physical_memory=2048\r\nSuccessfully updated VM f7c4fbb0-aa35-41d4-9d21-614caba785c7\r\n\r\n### VNC notes\r\n\r\nhttps://github.com/TigerVNC/tigervnc/releases\r\n\r\n\r\nconnect to **admin IP** and zone port (not zone IP)\r\n\r\nvmadm info <UUID> vnc\r\n\r\n### zpool expand\r\n\r\nhttp://blog.beulink.org/smartos-mirroring-your-zones-pool/\r\n\r\nhttp://blog.alainodea.com/en/article/448/making-a-zfs-4-disk-mirrored-vdev-zpool-on-smartos-on-r720xd\r\n\r\nhttp://prefetch.net/blog/index.php/2007/01/04/adding-a-mirror-to-a-device-in-a-zfs-pool/\r\n\r\nhttp://prefetch.net/blog/index.php/2011/10/15/using-the-zfs-scrub-feature-to-verify-the-integrity-of-your-storage/\r\n\r\n\r\n```\r\nAdding a mirror to a device in a ZFS pool\r\nIn one of my previous posts, I discussed how to add a disk to a ZFS pool. One thing I failed to mention was the fact that adding a device in this manner creates a second stripe in the pool, which adds no redundancy (in that specific example, I was using hardware RAID). Instead of using the zfs “add” command to add a second stripe to the pool, I could have instead used the “attach” option to create a two way mirror from the existing device:\r\n$ zpool attach system c1d0s0 c2d0s0\r\nThe attach operation will cause a new top level “mirror” vdev (virtual device) to be created, and both devices will then be associated with that vdev. Once the attach completes, the first device will be synced to the second device. You can monitor the synchronization progress with the zpool utility:\r\n$ zpool status -v\r\npool: system\r\nstate: ONLINE\r\nstatus: One or more devices is currently being resilvered.  The pool will\r\n        continue to function, possibly in a degraded state.\r\naction: Wait for the resilver to complete.\r\nscrub: resilver in progress, 3.13% done, 0h15m to go\r\nconfig:\r\n\r\n        NAME        STATE     READ WRITE CKSUM\r\n        system      ONLINE       0     0     0\r\n          mirror    ONLINE       0     0     0\r\n            c1d0s0  ONLINE       0     0     0\r\n            c2d0s0  ONLINE       0     0     0\r\nThe more I work with ZFS, the more I dig it!\r\n```\r\n\r\nWhen prompted at install I selected c0t0d0 as the drive for the zones zpool.\r\n\r\nHere is how I made it a mirrored vdev zpool:\r\n\r\n```\r\nzpool attach zones c0t0d0 c0d1t0\r\nzpool add zones mirror c0t2d0 c0t3d0\r\n\r\n```\r\n\r\nnote if adding a mirror to a single disk you need to add to the exising disk using\r\n\r\n```\r\nzpool attach zones existingdisk newdisk\r\n```\r\nOutput\r\n\r\n```\r\n\r\n[root@headnode (hat) ~]# zpool status\r\n  pool: zones\r\n state: ONLINE\r\n  scan: resilvered 49.6G in 0h15m with 0 errors on Wed Dec 23 22:28:07 2015\r\nconfig:\r\n\r\n        NAME        STATE     READ WRITE CKSUM\r\n        zones       ONLINE       0     0     0\r\n          mirror-0  ONLINE       0     0     0\r\n            c0t0d0  ONLINE       0     0     0\r\n            c0t2d0  ONLINE       0     0     0\r\n          c0t1d0    ONLINE       0     0     0\r\n\r\n\r\n[root@headnode (hat) ~]# zpool attach zones c0t1d0 c0t3d0\r\n\r\n[root@headnode (hat) ~]# zpool status\r\n  pool: zones\r\n state: ONLINE\r\nstatus: One or more devices is currently being resilvered.  The pool will\r\n        continue to function, possibly in a degraded state.\r\naction: Wait for the resilver to complete.\r\n  scan: resilver in progress since Thu Dec 24 01:06:57 2015\r\n    8.58G scanned out of 24.9G at 732M/s, 0h0m to go\r\n    6.40M resilvered, 34.51% done\r\nconfig:\r\n\r\n        NAME        STATE     READ WRITE CKSUM\r\n        zones       ONLINE       0     0     0\r\n          mirror-0  ONLINE       0     0     0\r\n            c0t0d0  ONLINE       0     0     0\r\n            c0t2d0  ONLINE       0     0     0\r\n          mirror-1  ONLINE       0     0     0\r\n            c0t1d0  ONLINE       0     0     0\r\n            c0t3d0  ONLINE       0     0     0  (resilvering)\r\n\r\n\r\n\r\n\r\n```\r\n\r\nRunning zpool status shows the following:\r\n\r\n```\r\n pool: zones\r\n state: ONLINE\r\n  scan: resilvered 4.00G in 0h0m with 0 errors on Fri Jan 18 01:11:15 2013\r\nconfig:\r\n\r\n        NAME        STATE     READ WRITE CKSUM\r\n        zones       ONLINE       0     0     0\r\n          mirror-0  ONLINE       0     0     0\r\n            c0t0d0  ONLINE       0     0     0\r\n            c0t1d0  ONLINE       0     0     0\r\n          mirror-1  ONLINE       0     0     0\r\n            c0t2d0  ONLINE       0     0     0\r\n            c0t3d0  ONLINE       0     0     0\r\n```\r\n\r\nIf you have mismatched disks like me, start smalles first and create the pool.\r\n\r\nnow my plan is to replace the 300gb with 2 tb as money allows, so i will turn on auto expand so as i replace the disks the pool grows and i can fit more machines\r\n\r\n```\r\nzpool set autoexpand=on zones\r\n```\r\n\r\n### Tools\r\n\r\nhttp://timboudreau.com/blog/smartos/read\r\n\r\n#### GB / MB Rounding\r\n\r\nIn oder to create a machine via SDC you need the **exact** size (e.g. 40000 mb is not accurate enough) so 40Gb is actually 40960 MB so you need to 40960, no less, no more.... (note google is not strict enough)\r\n\r\nuse this converter to help\r\n\r\nhttp://www.convertunits.com/from/GB/to/MB\r\n\r\n#### AWESOME TIPS\r\n\r\nhttps://wiki.smartos.org/display/DOC/SmartOS+Command+Line+Tips\r\n\r\nhttp://blogoless.blogspot.co.nz/search/label/smartos\r\n\r\n## Thanks\r\n\r\nThanks to everyone whos posts i have used (to many to mention!) but I have back linked where i had them as a reference.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}